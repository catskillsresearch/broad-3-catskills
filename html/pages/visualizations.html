<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizations - Spatial Transcriptomics Challenge Documentation</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <header>
        <div class="logo-container">
            <h1>Spatial Transcriptomics Challenge</h1>
        </div>
        <nav class="main-nav">
            <ul>
                <li><a href="../index.html">Home</a></li>
                <li><a href="input_data.html">Input Data</a></li>
                <li><a href="process_flow.html">Process Flow</a></li>
                <li><a href="deepspot_architecture.html">DeepSpot Architecture</a></li>
                <li><a href="implementation.html">Implementation</a></li>
                <li><a href="visualizations.html" class="active">Visualizations</a></li>
                <li><a href="crunch_approaches.html">Crunch Approaches</a></li>
                <li><a href="getting_started.html">Getting Started</a></li>
            </ul>
        </nav>
        <button class="mobile-menu-toggle">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="search-container">
                <input type="text" placeholder="Search documentation...">
                <button type="submit">Search</button>
            </div>
            <nav class="side-nav">
                <h3>On This Page</h3>
                <ul>
                    <li><a href="#overview">Overview</a></li>
                    <li><a href="#pipeline-integration">Pipeline Integration</a></li>
                    <li><a href="#data-exploration">Data Exploration Visualizations</a></li>
                    <li><a href="#feature-extraction">Feature Extraction Visualizations</a></li>
                    <li><a href="#model-performance">Model Performance Visualizations</a></li>
                    <li><a href="#gene-expression">Gene Expression Visualizations</a></li>
                    <li><a href="#spatial-patterns">Spatial Pattern Visualizations</a></li>
                    <li><a href="#differential-expression">Differential Expression Visualizations</a></li>
                    <li><a href="#implementation">Implementation in Code</a></li>
                    <li><a href="#wandb-integration">Weights & Biases Integration</a></li>
                </ul>
            </nav>
        </aside>

        <main class="content">
            <div class="breadcrumbs">
                <span><a href="../index.html">Home</a></span>
                <span>Visualizations</span>
            </div>

            <section id="overview">
                <h2>Visualization Overview</h2>
                <p>Visualizations play a crucial role in understanding, evaluating, and interpreting the results of the spatial transcriptomics challenge. This page presents a comprehensive collection of visualization techniques used throughout the pipeline, from data exploration to final gene ranking.</p>
                
                <div class="info-box">
                    <h3>Key Visualization Categories</h3>
                    <ul>
                        <li><strong>Data Exploration</strong>: Visualizing input data characteristics</li>
                        <li><strong>Feature Extraction</strong>: Visualizing extracted image features</li>
                        <li><strong>Model Performance</strong>: Visualizing model training and evaluation</li>
                        <li><strong>Gene Expression</strong>: Visualizing predicted gene expression patterns</li>
                        <li><strong>Spatial Patterns</strong>: Visualizing spatial distribution of gene expression</li>
                        <li><strong>Differential Expression</strong>: Visualizing differences between tissue regions</li>
                    </ul>
                </div>
            </section>

            <section id="pipeline-integration">
                <h2>Pipeline Integration</h2>
                <p>All visualizations are fully integrated into the Luigi pipeline and automatically logged to Weights & Biases for experiment tracking. The pipeline includes dedicated visualization tasks that can be run independently or as part of the full pipeline.</p>
                
                <h3>Visualization Pipeline Structure</h3>
                <p>The visualization pipeline consists of three main tasks:</p>
                
                <div class="mermaid-container">
                    <pre class="mermaid">
                        graph TD
                            A[PrepareTrainingData] --> B[VisualizeDataset]
                            A --> C[VisualizeModelPredictions]
                            A --> D[VisualizeDifferentialExpression]
                            E[PredictGeneExpression] --> C
                            B & C & D --> F[RunVisualizationPipeline]
                    </pre>
                </div>
                
                <h3>Running the Visualization Pipeline</h3>
                <p>You can run the visualization pipeline using the following command:</p>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Command Line - Run Visualization Pipeline</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="bash">
python scripts/run_pipeline.py --config config/config.yaml --experiment my_experiment --step visualize
                    </code></pre>
                </div>
                
                <p>This will generate all visualizations and log them to Weights & Biases for easy tracking and comparison.</p>
            </section>

            <section id="data-exploration">
                <h2>Data Exploration Visualizations</h2>
                <p>Data exploration visualizations help understand the characteristics of the input data and identify patterns or issues that might affect model performance.</p>
                
                <h3>Dataset Overview</h3>
                <p>The dataset overview visualization provides a comprehensive view of the dataset characteristics:</p>
                <ul>
                    <li>Spatial distribution of cells colored by region</li>
                    <li>Spatial distribution of cells colored by quality score</li>
                    <li>PCA of gene expression colored by region</li>
                    <li>Gene expression distributions</li>
                    <li>Gene-gene correlation heatmap</li>
                    <li>Dataset statistics summary</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeDataset</code> task in <code>pipeline_visualization.py</code></p>
                    <p>Method: <code>create_dataset_overview</code> in <code>visualization_module.py</code></p>
                </div>
                
                <div class="image-container">
                    <img src="../images/dataset_overview.png" alt="Dataset Overview Visualization">
                    <p class="caption">Comprehensive dataset overview showing spatial distribution, PCA, expression distributions, and correlation matrix.</p>
                </div>
                
                <h3>H&E Image Visualization</h3>
                <p>Visualizing H&E images provides insights into tissue morphology and cellular organization:</p>
                <ul>
                    <li>Original H&E images showing tissue structure</li>
                    <li>Overlay of cell positions on H&E images</li>
                    <li>Zoomed-in views of specific tissue regions</li>
                    <li>Comparison of dysplastic and non-dysplastic regions</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeDataset</code> task in <code>pipeline_visualization.py</code></p>
                </div>
                
                <div class="image-container">
                    <img src="../images/he_visualization.png" alt="H&E Image Visualization">
                    <p class="caption">Example H&E image with overlay of cell positions. Different colors represent different cell types or regions.</p>
                </div>
                
                <h3>Gene Expression Distribution</h3>
                <p>Visualizing the distribution of gene expression values helps understand the data characteristics:</p>
                <ul>
                    <li>Histograms of gene expression values</li>
                    <li>Box plots showing expression distribution across genes</li>
                    <li>Violin plots comparing expression in different tissue regions</li>
                    <li>Density plots of expression values</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeDataset</code> task in <code>pipeline_visualization.py</code></p>
                    <p>Included in the dataset overview visualization</p>
                </div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Gene Expression Distribution Visualization</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import pandas as pd

def visualize_expression_distribution(expression_df, gene_names=None, n_genes=10, figsize=(12, 8)):
    """Visualize distribution of gene expression values."""
    if gene_names is None:
        # Select random genes if not specified
        gene_names = np.random.choice(expression_df.columns, size=min(n_genes, len(expression_df.columns)), replace=False)
    
    # Create figure
    fig, axes = plt.subplots(2, 2, figsize=figsize)
    
    # Histogram of expression values
    ax = axes[0, 0]
    for gene in gene_names:
        sns.histplot(expression_df[gene], kde=True, ax=ax, label=gene)
    ax.set_title('Gene Expression Distribution')
    ax.set_xlabel('Expression Value')
    ax.set_ylabel('Frequency')
    ax.legend()
    
    # Box plot of expression values
    ax = axes[0, 1]
    data_to_plot = expression_df[gene_names].melt()
    sns.boxplot(x='variable', y='value', data=data_to_plot, ax=ax)
    ax.set_title('Expression Distribution by Gene')
    ax.set_xlabel('Gene')
    ax.set_ylabel('Expression Value')
    ax.set_xticklabels(ax.get_xticklabels(), rotation=45, ha='right')
    
    # Violin plot of expression values
    ax = axes[1, 0]
    sns.violinplot(x='variable', y='value', data=data_to_plot, ax=ax)
    ax.set_title('Expression Distribution by Gene (Violin Plot)')
    ax.set_xlabel('Gene')
    ax.set_ylabel('Expression Value')
    ax.set_xticklabels(ax.get_xticklabels(), rotation=45, ha='right')
    
    # Density plot of expression values
    ax = axes[1, 1]
    for gene in gene_names:
        sns.kdeplot(expression_df[gene], ax=ax, label=gene)
    ax.set_title('Gene Expression Density')
    ax.set_xlabel('Expression Value')
    ax.set_ylabel('Density')
    ax.legend()
    
    plt.tight_layout()
    return fig
                    </code></pre>
                </div>
            </section>

            <section id="feature-extraction">
                <h2>Feature Extraction Visualizations</h2>
                <p>Feature extraction visualizations help understand the features extracted from H&E images and their relationship to gene expression.</p>
                
                <h3>Dimensionality Reduction</h3>
                <p>Dimensionality reduction techniques help visualize high-dimensional feature spaces:</p>
                <ul>
                    <li><strong>PCA (Principal Component Analysis)</strong>: Visualizing the principal components of image features</li>
                    <li><strong>t-SNE (t-Distributed Stochastic Neighbor Embedding)</strong>: Visualizing local relationships between features</li>
                    <li><strong>UMAP (Uniform Manifold Approximation and Projection)</strong>: Visualizing global and local structure of feature space</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeModelPredictions</code> task in <code>pipeline_visualization.py</code></p>
                    <p>Methods: <code>_create_pca_visualization</code>, <code>_create_tsne_visualization</code>, <code>_create_umap_visualization</code> in <code>visualization_module.py</code></p>
                </div>
                
                <div class="image-container">
                    <img src="../images/umap_features.png" alt="UMAP Visualization of Image Features">
                    <p class="caption">UMAP visualization of image features colored by tissue region. Clusters indicate similar morphological patterns.</p>
                </div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Dimensionality Reduction Visualization</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
from sklearn.decomposition import PCA
from sklearn.manifold import TSNE
import umap

def visualize_dimensionality_reduction(features, labels=None, figsize=(18, 6)):
    """Visualize dimensionality reduction of features using PCA, t-SNE, and UMAP."""
    # Create figure
    fig, axes = plt.subplots(1, 3, figsize=figsize)
    
    # PCA
    pca = PCA(n_components=2)
    pca_result = pca.fit_transform(features)
    
    ax = axes[0]
    if labels is not None:
        scatter = ax.scatter(pca_result[:, 0], pca_result[:, 1], c=labels, cmap='viridis', alpha=0.7)
        legend = ax.legend(*scatter.legend_elements(), title="Regions")
        ax.add_artist(legend)
    else:
        ax.scatter(pca_result[:, 0], pca_result[:, 1], alpha=0.7)
    ax.set_title(f'PCA (explained variance: {pca.explained_variance_ratio_.sum():.2f})')
    ax.set_xlabel('Principal Component 1')
    ax.set_ylabel('Principal Component 2')
    
    # t-SNE
    tsne = TSNE(n_components=2, random_state=42)
    tsne_result = tsne.fit_transform(features)
    
    ax = axes[1]
    if labels is not None:
        scatter = ax.scatter(tsne_result[:, 0], tsne_result[:, 1], c=labels, cmap='viridis', alpha=0.7)
        legend = ax.legend(*scatter.legend_elements(), title="Regions")
        ax.add_artist(legend)
    else:
        ax.scatter(tsne_result[:, 0], tsne_result[:, 1], alpha=0.7)
    ax.set_title('t-SNE')
    ax.set_xlabel('t-SNE 1')
    ax.set_ylabel('t-SNE 2')
    
    # UMAP
    reducer = umap.UMAP(random_state=42)
    umap_result = reducer.fit_transform(features)
    
    ax = axes[2]
    if labels is not None:
        scatter = ax.scatter(umap_result[:, 0], umap_result[:, 1], c=labels, cmap='viridis', alpha=0.7)
        legend = ax.legend(*scatter.legend_elements(), title="Regions")
        ax.add_artist(legend)
    else:
        ax.scatter(umap_result[:, 0], umap_result[:, 1], alpha=0.7)
    ax.set_title('UMAP')
    ax.set_xlabel('UMAP 1')
    ax.set_ylabel('UMAP 2')
    
    plt.tight_layout()
    return fig, (pca_result, tsne_result, umap_result)
                    </code></pre>
                </div>
            </section>

            <section id="model-performance">
                <h2>Model Performance Visualizations</h2>
                <p>Model performance visualizations help evaluate the quality of gene expression predictions and track model training progress.</p>
                
                <h3>Training Metrics</h3>
                <p>Visualizing training metrics helps track model training progress:</p>
                <ul>
                    <li>Line plots of training and validation loss over epochs</li>
                    <li>Line plots of Spearman correlation over epochs</li>
                    <li>Learning rate schedules</li>
                    <li>Gradient norms during training</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Automatically logged to Weights & Biases during model training</p>
                    <p>Generated by PyTorch Lightning's <code>WandbLogger</code> in <code>pipeline_model_training.py</code></p>
                </div>
                
                <div class="image-container">
                    <img src="../images/training_metrics.png" alt="Training Metrics Visualization">
                    <p class="caption">Training and validation metrics over epochs, showing loss and Spearman correlation.</p>
                </div>
                
                <h3>Prediction Accuracy</h3>
                <p>Visualizing prediction accuracy helps evaluate model performance:</p>
                <ul>
                    <li>Scatter plots of predicted vs. actual expression values</li>
                    <li>Histograms of prediction errors</li>
                    <li>Box plots of prediction accuracy across genes</li>
                    <li>Heatmaps of correlation matrices</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeModelPredictions</code> task in <code>pipeline_visualization.py</code></p>
                    <p>Method: <code>create_prediction_accuracy_visualization</code> in <code>visualization_module.py</code></p>
                </div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Prediction Accuracy Visualization</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
from scipy.stats import spearmanr

def visualize_prediction_accuracy(predictions, targets, gene_names=None, n_genes=5, figsize=(15, 12)):
    """Visualize prediction accuracy for gene expression."""
    if gene_names is None:
        # Select random genes if not specified
        gene_names = np.random.choice(range(predictions.shape[1]), size=min(n_genes, predictions.shape[1]), replace=False)
        gene_labels = [f'Gene {i}' for i in gene_names]
    else:
        gene_labels = gene_names
        gene_names = [list(gene_names).index(g) for g in gene_names[:n_genes]]
    
    # Create figure
    fig, axes = plt.subplots(2, 2, figsize=figsize)
    
    # Scatter plots of predicted vs. actual values
    ax = axes[0, 0]
    for i, gene_idx in enumerate(gene_names):
        ax.scatter(
            targets[:, gene_idx],
            predictions[:, gene_idx],
            alpha=0.5,
            label=gene_labels[i]
        )
    
    # Add diagonal line
    min_val = min(targets.min(), predictions.min())
    max_val = max(targets.max(), predictions.max())
    ax.plot([min_val, max_val], [min_val, max_val], 'k--')
    
    ax.set_title('Predicted vs. Actual Expression')
    ax.set_xlabel('Actual Expression')
    ax.set_ylabel('Predicted Expression')
    ax.legend()
    
    # Histogram of prediction errors
    ax = axes[0, 1]
    for i, gene_idx in enumerate(gene_names):
        errors = predictions[:, gene_idx] - targets[:, gene_idx]
        sns.histplot(errors, kde=True, ax=ax, label=gene_labels[i], alpha=0.5)
    
    ax.set_title('Prediction Error Distribution')
    ax.set_xlabel('Prediction Error')
    ax.set_ylabel('Frequency')
    ax.legend()
    
    # Box plot of Spearman correlations across genes
    ax = axes[1, 0]
    
    # Compute cell-wise Spearman correlations
    cell_correlations = []
    for i in range(predictions.shape[0]):
        corr, _ = spearmanr(predictions[i, :], targets[i, :])
        cell_correlations.append(corr)
    
    # Compute gene-wise Spearman correlations
    gene_correlations = []
    for i in range(predictions.shape[1]):
        corr, _ = spearmanr(predictions[:, i], targets[:, i])
        gene_correlations.append(corr)
    
    # Create box plots
    data = [cell_correlations, gene_correlations]
    labels = ['Cell-wise', 'Gene-wise']
    
    sns.boxplot(data=data, ax=ax)
    ax.set_title('Spearman Correlation Distribution')
    ax.set_xticklabels(labels)
    ax.set_ylabel('Spearman Correlation')
    
    # Heatmap of correlation matrix for selected genes
    ax = axes[1, 1]
    
    # Compute correlation matrix
    corr_matrix = np.zeros((len(gene_names), len(gene_names)))
    for i, gene_i in enumerate(gene_names):
        for j, gene_j in enumerate(gene_names):
            corr, _ = spearmanr(predictions[:, gene_i], predictions[:, gene_j])
            corr_matrix[i, j] = corr
    
    # Plot heatmap
    sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', vmin=-1, vmax=1, ax=ax,
                xticklabels=gene_labels, yticklabels=gene_labels)
    ax.set_title('Correlation Matrix of Predicted Expression')
    
    plt.tight_layout()
    return fig
                    </code></pre>
                </div>
                
                <h3>Dimensionality Reduction of Predictions</h3>
                <p>Visualizing predictions and ground truth in reduced dimensionality space helps understand model performance:</p>
                <ul>
                    <li>PCA plots comparing predictions to ground truth</li>
                    <li>t-SNE plots comparing predictions to ground truth</li>
                    <li>UMAP plots comparing predictions to ground truth</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeModelPredictions</code> task in <code>pipeline_visualization.py</code></p>
                    <p>Method: <code>create_dimensionality_reduction_visualizations</code> in <code>visualization_module.py</code></p>
                </div>
                
                <div class="image-container">
                    <img src="../images/tsne_predictions.png" alt="t-SNE Visualization of Predictions vs Ground Truth">
                    <p class="caption">t-SNE visualization comparing predicted gene expression (blue) to ground truth (red). Gray lines connect corresponding points.</p>
                </div>
            </section>

            <section id="gene-expression">
                <h2>Gene Expression Visualizations</h2>
                <p>Gene expression visualizations help understand the patterns and relationships in gene expression data.</p>
                
                <h3>Expression Heatmaps</h3>
                <p>Heatmaps provide a comprehensive view of gene expression patterns:</p>
                <ul>
                    <li>Heatmaps of gene expression across cells</li>
                    <li>Clustered heatmaps showing gene modules</li>
                    <li>Heatmaps comparing predicted and actual expression</li>
                    <li>Heatmaps showing expression differences between tissue regions</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeModelPredictions</code> task in <code>pipeline_visualization.py</code></p>
                    <p>Included in prediction accuracy visualizations</p>
                </div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Expression Heatmap Visualization</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
from scipy.cluster.hierarchy import linkage, dendrogram
from scipy.spatial.distance import pdist

def visualize_expression_heatmap(expression_data, gene_names=None, cell_labels=None, 
                                n_genes=50, n_cells=100, cluster_genes=True, 
                                cluster_cells=True, figsize=(12, 10)):
    """Visualize gene expression heatmap with optional clustering."""
    # Select subset of genes and cells if needed
    if expression_data.shape[1] > n_genes:
        # Select genes with highest variance
        gene_var = np.var(expression_data, axis=0)
        top_genes = np.argsort(gene_var)[-n_genes:]
        expression_subset = expression_data[:, top_genes]
        if gene_names is not None:
            gene_names = [gene_names[i] for i in top_genes]
        else:
            gene_names = [f'Gene {i}' for i in top_genes]
    else:
        expression_subset = expression_data
        if gene_names is None:
            gene_names = [f'Gene {i}' for i in range(expression_data.shape[1])]
    
    if expression_subset.shape[0] > n_cells:
        # Select random cells
        cell_idx = np.random.choice(expression_subset.shape[0], size=n_cells, replace=False)
        expression_subset = expression_subset[cell_idx, :]
        if cell_labels is not None:
            cell_labels = [cell_labels[i] for i in cell_idx]
    elif cell_labels is None:
        cell_labels = [f'Cell {i}' for i in range(expression_subset.shape[0])]
    
    # Create figure
    fig, ax = plt.subplots(figsize=figsize)
    
    # Compute linkage for clustering
    if cluster_genes:
        gene_linkage = linkage(pdist(expression_subset.T), method='average')
        gene_order = dendrogram(gene_linkage, no_plot=True)['leaves']
        expression_subset = expression_subset[:, gene_order]
        gene_names = [gene_names[i] for i in gene_order]
    
    if cluster_cells:
        cell_linkage = linkage(pdist(expression_subset), method='average')
        cell_order = dendrogram(cell_linkage, no_plot=True)['leaves']
        expression_subset = expression_subset[cell_order, :]
        cell_labels = [cell_labels[i] for i in cell_order]
    
    # Plot heatmap
    sns.heatmap(expression_subset, cmap='viridis', xticklabels=gene_names, 
                yticklabels=cell_labels, ax=ax)
    
    ax.set_title('Gene Expression Heatmap')
    ax.set_xlabel('Genes')
    ax.set_ylabel('Cells')
    
    # Rotate x-axis labels for readability
    plt.xticks(rotation=90)
    
    plt.tight_layout()
    return fig
                    </code></pre>
                </div>
            </section>

            <section id="spatial-patterns">
                <h2>Spatial Pattern Visualizations</h2>
                <p>Spatial pattern visualizations help understand the spatial distribution of gene expression within tissue.</p>
                
                <h3>Spatial Expression Maps</h3>
                <p>Spatial maps show the distribution of gene expression across tissue:</p>
                <ul>
                    <li>Scatter plots of cells colored by expression level</li>
                    <li>Heatmaps overlaid on tissue images</li>
                    <li>Contour plots showing expression gradients</li>
                    <li>3D surface plots of expression landscapes</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeDataset</code> task in <code>pipeline_visualization.py</code></p>
                    <p>Method: <code>create_spatial_expression_map</code> in <code>visualization_module.py</code></p>
                </div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Spatial Expression Map Visualization</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
import matplotlib.pyplot as plt
import numpy as np
from matplotlib.colors import Normalize
from scipy.ndimage import gaussian_filter

def visualize_spatial_expression(cell_positions, expression_values, he_image=None, 
                                gene_names=None, n_genes=4, figsize=(15, 12)):
    """Visualize spatial distribution of gene expression."""
    if gene_names is None:
        # Select genes with highest spatial variance
        spatial_var = []
        for i in range(expression_values.shape[1]):
            # Compute spatial autocorrelation or variance
            spatial_var.append(np.var(expression_values[:, i]))
        
        top_genes = np.argsort(spatial_var)[-n_genes:]
        gene_labels = [f'Gene {i}' for i in top_genes]
    else:
        if len(gene_names) > n_genes:
            # Select first n_genes
            gene_names = gene_names[:n_genes]
        top_genes = range(len(gene_names))
        gene_labels = gene_names
    
    # Create figure
    fig, axes = plt.subplots(2, 2, figsize=figsize)
    axes = axes.flatten()
    
    for i, (gene_idx, gene_label) in enumerate(zip(top_genes, gene_labels)):
        ax = axes[i]
        
        # Get expression values for this gene
        expr = expression_values[:, gene_idx]
        
        # Normalize expression values
        norm = Normalize(vmin=np.percentile(expr, 1), vmax=np.percentile(expr, 99))
        
        # If H&E image is provided, show it as background
        if he_image is not None:
            ax.imshow(he_image, alpha=0.5)
        
        # Plot cells colored by expression
        scatter = ax.scatter(
            cell_positions[:, 0],
            cell_positions[:, 1],
            c=expr,
            cmap='viridis',
            norm=norm,
            alpha=0.7,
            s=10
        )
        
        # Add colorbar
        cbar = plt.colorbar(scatter, ax=ax)
        cbar.set_label('Expression')
        
        ax.set_title(f'{gene_label} Expression')
        ax.set_xlabel('X Position')
        ax.set_ylabel('Y Position')
        ax.set_aspect('equal')
    
    plt.tight_layout()
    return fig
                    </code></pre>
                </div>
            </section>

            <section id="differential-expression">
                <h2>Differential Expression Visualizations</h2>
                <p>Differential expression visualizations help identify genes that are differentially expressed between tissue regions.</p>
                
                <h3>Volcano Plots</h3>
                <p>Volcano plots show the relationship between statistical significance and fold change:</p>
                <ul>
                    <li>Scatter plots of -log10(p-value) vs. log2(fold change)</li>
                    <li>Highlighted points for significantly differentially expressed genes</li>
                    <li>Labeled points for top genes</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Generated by <code>VisualizeDifferentialExpression</code> task in <code>pipeline_visualization.py</code></p>
                    <p>Method: <code>create_volcano_plot</code> in <code>visualization_module.py</code></p>
                </div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Volcano Plot Visualization</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from scipy import stats

def visualize_volcano_plot(expression_df, region_labels, gene_names=None, 
                          p_threshold=0.05, fc_threshold=1.0, figsize=(10, 8)):
    """Visualize volcano plot for differential expression analysis."""
    # Split cells by region
    dysplastic_cells = expression_df[region_labels == 'dysplastic']
    non_dysplastic_cells = expression_df[region_labels == 'non_dysplastic']
    
    # Initialize results
    results = []
    
    # Calculate statistics for each gene
    for gene in expression_df.columns:
        # Get expression values for this gene
        dysplastic_expr = dysplastic_cells[gene].values
        non_dysplastic_expr = non_dysplastic_cells[gene].values
        
        # Calculate mean expression in each region
        mean_dysplastic = np.mean(dysplastic_expr)
        mean_non_dysplastic = np.mean(non_dysplastic_expr)
        
        # Calculate log fold change
        epsilon = 1e-10  # Small constant to avoid log(0)
        logFC = np.log2((mean_dysplastic + epsilon) / (mean_non_dysplastic + epsilon))
        
        # Calculate p-value using t-test
        t_stat, p_value = stats.ttest_ind(dysplastic_expr, non_dysplastic_expr)
        
        # Store results
        results.append({
            'Gene': gene,
            'logFC': logFC,
            'p_value': p_value,
            'mean_dysplastic': mean_dysplastic,
            'mean_non_dysplastic': mean_non_dysplastic
        })
    
    # Create DataFrame
    results_df = pd.DataFrame(results)
    
    # Add -log10(p-value)
    results_df['-log10(p)'] = -np.log10(results_df['p_value'])
    
    # Create figure
    fig, ax = plt.subplots(figsize=figsize)
    
    # Plot all points
    ax.scatter(
        results_df['logFC'],
        results_df['-log10(p)'],
        alpha=0.7,
        s=10,
        color='gray'
    )
    
    # Highlight significant points
    significant = (results_df['p_value'] < p_threshold) & (np.abs(results_df['logFC']) > fc_threshold)
    
    ax.scatter(
        results_df.loc[significant, 'logFC'],
        results_df.loc[significant, '-log10(p)'],
        alpha=0.7,
        s=20,
        color='red'
    )
    
    # Add threshold lines
    ax.axhline(-np.log10(p_threshold), color='blue', linestyle='--')
    ax.axvline(fc_threshold, color='blue', linestyle='--')
    ax.axvline(-fc_threshold, color='blue', linestyle='--')
    
    # Label top genes
    top_genes = results_df.loc[significant].sort_values('-log10(p)', ascending=False).head(10)
    
    for _, row in top_genes.iterrows():
        ax.text(
            row['logFC'],
            row['-log10(p)'],
            row['Gene'],
            fontsize=8,
            ha='center',
            va='bottom'
        )
    
    ax.set_title('Volcano Plot: Dysplastic vs. Non-dysplastic Regions')
    ax.set_xlabel('log2(Fold Change)')
    ax.set_ylabel('-log10(p-value)')
    
    # Add text annotations for quadrants
    ax.text(
        np.max(results_df['logFC']) * 0.8,
        np.max(results_df['-log10(p)']) * 0.8,
        'Up in Dysplastic',
        fontsize=10,
        ha='center',
        va='center',
        bbox=dict(facecolor='white', alpha=0.7)
    )
    
    ax.text(
        np.min(results_df['logFC']) * 0.8,
        np.max(results_df['-log10(p)']) * 0.8,
        'Down in Dysplastic',
        fontsize=10,
        ha='center',
        va='center',
        bbox=dict(facecolor='white', alpha=0.7)
    )
    
    plt.tight_layout()
    return fig, results_df
                    </code></pre>
                </div>
                
                <h3>MA Plots</h3>
                <p>MA plots show the relationship between mean expression and fold change:</p>
                <ul>
                    <li>Scatter plots of log2(fold change) vs. log2(mean expression)</li>
                    <li>Highlighted points for significantly differentially expressed genes</li>
                    <li>Smoothed trend lines showing overall patterns</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Can be added to <code>VisualizeDifferentialExpression</code> task in <code>pipeline_visualization.py</code></p>
                </div>
                
                <div class="image-container">
                    <img src="../images/ma_plot.png" alt="MA Plot Visualization">
                    <p class="caption">MA plot showing the relationship between mean expression and fold change. Red points indicate significantly differentially expressed genes.</p>
                </div>
            </section>

            <section id="implementation">
                <h2>Implementation in Code</h2>
                <p>The implementation includes a comprehensive set of visualization functions that can be used throughout the pipeline.</p>
                
                <h3>Visualization Module</h3>
                <p>The visualization module provides a unified interface for creating visualizations:</p>
                <ul>
                    <li>Functions for each visualization type</li>
                    <li>Consistent parameter naming and defaults</li>
                    <li>Support for saving visualizations to files</li>
                    <li>Integration with Weights & Biases for experiment tracking</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Implemented in <code>visualization_module.py</code></p>
                    <p>Integrated into the Luigi pipeline via <code>pipeline_visualization.py</code></p>
                </div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Visualization Module</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import pandas as pd
from scipy import stats
import umap
from sklearn.decomposition import PCA
from sklearn.manifold import TSNE
import wandb

class VisualizationModule:
    """Module for creating visualizations throughout the pipeline."""
    
    def __init__(self, output_dir, experiment_name=None, use_wandb=True):
        """Initialize visualization module."""
        self.output_dir = output_dir
        self.experiment_name = experiment_name
        self.use_wandb = use_wandb
        
        # Create visualization directory
        self.vis_dir = os.path.join(output_dir, 'visualizations')
        os.makedirs(self.vis_dir, exist_ok=True)
        
        # Initialize wandb if needed
        if self.use_wandb and not wandb.run:
            wandb.init(
                project="spatial-transcriptomics",
                name=self.experiment_name,
                dir=output_dir
            )
    
    def create_dataset_overview(self, gene_expression, cell_coordinates, region_labels, 
                               quality_scores=None, gene_names=None):
        """Create dataset overview visualizations."""
        # Implementation details...
        
        # Log to wandb
        if self.use_wandb:
            wandb.log({"dataset_overview": wandb.Image(save_path)})
        
        return save_path
    
    def create_volcano_plot(self, expression_data, region_labels, gene_names=None, 
                           p_threshold=0.05, fc_threshold=1.0, figsize=(10, 8)):
        """Create volcano plot for differential expression analysis."""
        # Implementation details...
        
        # Log to wandb
        if self.use_wandb:
            wandb.log({"volcano_plot": wandb.Image(save_path)})
        
        return save_path
    
    # Additional visualization methods...
                    </code></pre>
                </div>
                
                <h3>Luigi Pipeline Integration</h3>
                <p>The visualization module is integrated into the Luigi pipeline through dedicated tasks:</p>
                <ul>
                    <li><code>VisualizeDataset</code>: Creates dataset overview and spatial expression visualizations</li>
                    <li><code>VisualizeModelPredictions</code>: Creates prediction accuracy and dimensionality reduction visualizations</li>
                    <li><code>VisualizeDifferentialExpression</code>: Creates volcano plots and other differential expression visualizations</li>
                    <li><code>RunVisualizationPipeline</code>: Runs all visualization tasks</li>
                </ul>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Luigi Pipeline Integration</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
import luigi
import os
import yaml
import numpy as np
from visualization_module import VisualizationModule

class VisualizeDataset(luigi.Task):
    """Luigi task for creating dataset visualizations."""
    config_path = luigi.Parameter(description="Path to the configuration file")
    
    def requires(self):
        from pipeline.pipeline_data_preparation import PrepareTrainingData
        return PrepareTrainingData(config_path=self.config_path)
    
    def output(self):
        # Output definition...
    
    def run(self):
        # Load data and create visualizations...
        vis_module = VisualizationModule(
            output_dir=output_dir,
            experiment_name=f"dataset_visualization_{os.path.basename(self.config_path)}",
            use_wandb=True
        )
        
        # Create dataset overview visualization
        vis_module.create_dataset_overview(
            gene_expression=gene_expression,
            cell_coordinates=cell_coordinates,
            region_labels=region_labels,
            quality_scores=quality_scores,
            gene_names=gene_names
        )
        
        # Create spatial expression map visualization
        vis_module.create_spatial_expression_map(
            cell_coordinates=cell_coordinates,
            expression_values=gene_expression,
            gene_names=gene_names
        )
                    </code></pre>
                </div>
            </section>

            <section id="wandb-integration">
                <h2>Weights & Biases Integration</h2>
                <p>All visualizations are automatically logged to Weights & Biases for experiment tracking and comparison.</p>
                
                <h3>Automatic Logging</h3>
                <p>The visualization module automatically logs all visualizations to Weights & Biases:</p>
                <ul>
                    <li>Images are logged using <code>wandb.Image</code></li>
                    <li>Metrics are logged using <code>wandb.log</code></li>
                    <li>Experiments are organized by experiment name</li>
                </ul>
                
                <div class="info-box">
                    <h4>Pipeline Location</h4>
                    <p>Implemented in <code>visualization_module.py</code></p>
                    <p>Each visualization method includes wandb logging</p>
                </div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span>Python - Weights & Biases Integration</span>
                        <button class="copy-button">Copy</button>
                    </div>
                    <pre><code class="python">
# Example of wandb logging in visualization methods
def create_volcano_plot(self, expression_data, region_labels, gene_names=None, 
                       p_threshold=0.05, fc_threshold=1.0, figsize=(10, 8)):
    """Create volcano plot for differential expression analysis."""
    # Implementation details...
    
    # Save figure
    save_path = os.path.join(self.vis_dir, 'volcano_plot.png')
    plt.savefig(save_path, dpi=300, bbox_inches='tight')
    plt.close()
    
    # Log to wandb
    if self.use_wandb:
        wandb.log({
            "volcano_plot": wandb.Image(save_path),
            "volcano_plot_data": {
                "significant_genes": len(significant),
                "up_regulated": len(results_df[significant & (results_df['logFC'] > 0)]),
                "down_regulated": len(results_df[significant & (results_df['logFC'] < 0)]),
                "p_threshold": p_threshold,
                "fc_threshold": fc_threshold
            }
        })
    
    return save_path
                    </code></pre>
                </div>
                
                <h3>Experiment Comparison</h3>
                <p>Weights & Biases allows easy comparison of visualizations across experiments:</p>
                <ul>
                    <li>Compare model performance across different hyperparameters</li>
                    <li>Compare differential expression results across different tissue regions</li>
                    <li>Track changes in visualizations over time</li>
                </ul>
                
                <div class="image-container">
                    <img src="../images/wandb_dashboard.png" alt="Weights & Biases Dashboard">
                    <p class="caption">Weights & Biases dashboard showing experiment tracking and visualization comparison.</p>
                </div>
            </section>
        </main>
    </div>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Spatial Transcriptomics Challenge. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize mermaid
            mermaid.initialize({ startOnLoad: true });
            
            // Initialize highlight.js
            hljs.highlightAll();
            
            // Mobile menu toggle
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const mainNav = document.querySelector('.main-nav');
            
            mobileMenuToggle.addEventListener('click', function() {
                mainNav.classList.toggle('active');
                mobileMenuToggle.classList.toggle('active');
            });
            
            // Copy button functionality
            const copyButtons = document.querySelectorAll('.copy-button');
            
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const codeBlock = this.parentElement.nextElementSibling.querySelector('code');
                    const textToCopy = codeBlock.textContent;
                    
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        this.textContent = 'Copied!';
                        setTimeout(() => {
                            this.textContent = 'Copy';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                });
            });
        });
    </script>
</body>
</html>
